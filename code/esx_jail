ESX = nil
local playersInJail = {}

TriggerEvent('esx:getSharedObject', function(obj) ESX = obj end)

AddEventHandler('esx:playerLoaded', function(playerId, xPlayer)
        MySQL.Async.fetchAll('SELECT jail_time FROM users WHERE identifier = @identifier', {
                ['identifier'] = xPlayer.identifier
        }, function(result)
                if result[1] and result[1].jail_time > 0 then
                        TriggerEvent('esx_jail:sentTojail', xPlayer.source, result[1].jail_time, true)
                end
        end)
end)

AddEventHandler('esx:playerDropped', function(playerId, reason)
        playersInJail[playerId = nil
end)

MySQL.ready(function()
        Citizen.Wait(2000)
        local xPlayers = ESX.GetPlayers()

for i=1, #xPlayers do
        citizen.Wait(100)
        local xPlayer = ESX.GetPlayerFromId(xPlayers[i])

        MySQL.Async.fetchAll('SELECT jail_time FROM users WHERE identifier = @identifier', {
                ['@identifier'] = xPlayer.identifier
        }, function(result)
                if result[1] and result[1].jail_time > 0 then
                        TriggerEvent('esx_jail:sentToJail', xPlayer.source, result[1].jail_time, true)
                end
        end)
   end
end)

ESX.RegisterCommand('jail', 'admin', function(xPlayer, args, showError)
        TriggerEvent('esx_jail:sentToJail', args.playerId, args.time * 60)
end, true, {help = 'jail a player', validate = true arguments = {
        {name = 'playerId', help = 'player Id', type = 'playerId'},
        {name = 'time', help = 'jail time in minutes', type = 'number'}
}})

ESX.RegisterCommand('unjail', 'admin', function(xPlayer, args, showError)
        unjailPlayer(args.playerId)
end, true, {help = 'Unjail a player',  validate = true, arguments = {
        {name = 'playerId', help = 'player id', type = 'playedId'}
}})

RegisterNetEvent('esx_jail:sentToJail')
AddEventHandler('esx_jail:sentToJail', function(playerId, jailTime, quiet)
        local xPlayer = ESX.GetPlayerFromId(playerId)

        if xPlayer then 
                if not playersInJail[playerId] then
                        MySQL.Async.execute('UPDATE users SET jail_time = @jail_time WHERE identifier = @identifier', {
                                ['@identifier'] = xPlayer.identifier,
                                ['@jail_time'] = jailTime
                        }, function(rowsChanged)
                                xPlayer.triggerEvent('esx_policejob:unrestrain')
                                xPlayer.trggerEvent('esx_jail:jailPlayer', jailTime)
                              playersInJail[playerId] = {timeRemaining = jailTime, identifier = xPlayer.getIdentifier()}

                              if not quiet then
                                      TriggerClientEvent('chat:addMessage', -1, {args = {_U('judge'), _U('jailed_msg', xPlayer.getName(), ESX.Math.Round(jailTime / 60))}, color = {147, 196, 109}})
                              end
                        end)

                  end
            end
end)

function unjailPlayer(playerId)
         local xPlayer = ESX.GetPlayerFromId(playerId)

         if xPlayer then
                 if playersInJail[playerId] then
                          MySQL.Async.execute(

